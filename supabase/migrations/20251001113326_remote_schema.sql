revoke delete on table "public"."attendance" from "anon";

revoke insert on table "public"."attendance" from "anon";

revoke references on table "public"."attendance" from "anon";

revoke select on table "public"."attendance" from "anon";

revoke trigger on table "public"."attendance" from "anon";

revoke truncate on table "public"."attendance" from "anon";

revoke update on table "public"."attendance" from "anon";

revoke delete on table "public"."attendance" from "authenticated";

revoke insert on table "public"."attendance" from "authenticated";

revoke references on table "public"."attendance" from "authenticated";

revoke select on table "public"."attendance" from "authenticated";

revoke trigger on table "public"."attendance" from "authenticated";

revoke truncate on table "public"."attendance" from "authenticated";

revoke update on table "public"."attendance" from "authenticated";

revoke delete on table "public"."attendance" from "service_role";

revoke insert on table "public"."attendance" from "service_role";

revoke references on table "public"."attendance" from "service_role";

revoke select on table "public"."attendance" from "service_role";

revoke trigger on table "public"."attendance" from "service_role";

revoke truncate on table "public"."attendance" from "service_role";

revoke update on table "public"."attendance" from "service_role";

revoke delete on table "public"."enrolment" from "anon";

revoke insert on table "public"."enrolment" from "anon";

revoke references on table "public"."enrolment" from "anon";

revoke select on table "public"."enrolment" from "anon";

revoke trigger on table "public"."enrolment" from "anon";

revoke truncate on table "public"."enrolment" from "anon";

revoke update on table "public"."enrolment" from "anon";

revoke delete on table "public"."enrolment" from "authenticated";

revoke insert on table "public"."enrolment" from "authenticated";

revoke references on table "public"."enrolment" from "authenticated";

revoke select on table "public"."enrolment" from "authenticated";

revoke trigger on table "public"."enrolment" from "authenticated";

revoke truncate on table "public"."enrolment" from "authenticated";

revoke update on table "public"."enrolment" from "authenticated";

revoke delete on table "public"."enrolment" from "service_role";

revoke insert on table "public"."enrolment" from "service_role";

revoke references on table "public"."enrolment" from "service_role";

revoke select on table "public"."enrolment" from "service_role";

revoke trigger on table "public"."enrolment" from "service_role";

revoke truncate on table "public"."enrolment" from "service_role";

revoke update on table "public"."enrolment" from "service_role";

revoke delete on table "public"."meeting" from "anon";

revoke insert on table "public"."meeting" from "anon";

revoke references on table "public"."meeting" from "anon";

revoke select on table "public"."meeting" from "anon";

revoke trigger on table "public"."meeting" from "anon";

revoke truncate on table "public"."meeting" from "anon";

revoke update on table "public"."meeting" from "anon";

revoke delete on table "public"."meeting" from "authenticated";

revoke insert on table "public"."meeting" from "authenticated";

revoke references on table "public"."meeting" from "authenticated";

revoke select on table "public"."meeting" from "authenticated";

revoke trigger on table "public"."meeting" from "authenticated";

revoke truncate on table "public"."meeting" from "authenticated";

revoke update on table "public"."meeting" from "authenticated";

revoke delete on table "public"."meeting" from "service_role";

revoke insert on table "public"."meeting" from "service_role";

revoke references on table "public"."meeting" from "service_role";

revoke select on table "public"."meeting" from "service_role";

revoke trigger on table "public"."meeting" from "service_role";

revoke truncate on table "public"."meeting" from "service_role";

revoke update on table "public"."meeting" from "service_role";

revoke delete on table "public"."member" from "anon";

revoke insert on table "public"."member" from "anon";

revoke references on table "public"."member" from "anon";

revoke select on table "public"."member" from "anon";

revoke trigger on table "public"."member" from "anon";

revoke truncate on table "public"."member" from "anon";

revoke update on table "public"."member" from "anon";

revoke delete on table "public"."member" from "authenticated";

revoke insert on table "public"."member" from "authenticated";

revoke references on table "public"."member" from "authenticated";

revoke select on table "public"."member" from "authenticated";

revoke trigger on table "public"."member" from "authenticated";

revoke truncate on table "public"."member" from "authenticated";

revoke update on table "public"."member" from "authenticated";

revoke delete on table "public"."member" from "service_role";

revoke insert on table "public"."member" from "service_role";

revoke references on table "public"."member" from "service_role";

revoke select on table "public"."member" from "service_role";

revoke trigger on table "public"."member" from "service_role";

revoke truncate on table "public"."member" from "service_role";

revoke update on table "public"."member" from "service_role";

revoke delete on table "public"."message" from "anon";

revoke insert on table "public"."message" from "anon";

revoke references on table "public"."message" from "anon";

revoke select on table "public"."message" from "anon";

revoke trigger on table "public"."message" from "anon";

revoke truncate on table "public"."message" from "anon";

revoke update on table "public"."message" from "anon";

revoke delete on table "public"."message" from "authenticated";

revoke insert on table "public"."message" from "authenticated";

revoke references on table "public"."message" from "authenticated";

revoke select on table "public"."message" from "authenticated";

revoke trigger on table "public"."message" from "authenticated";

revoke truncate on table "public"."message" from "authenticated";

revoke update on table "public"."message" from "authenticated";

revoke delete on table "public"."message" from "service_role";

revoke insert on table "public"."message" from "service_role";

revoke references on table "public"."message" from "service_role";

revoke select on table "public"."message" from "service_role";

revoke trigger on table "public"."message" from "service_role";

revoke truncate on table "public"."message" from "service_role";

revoke update on table "public"."message" from "service_role";

revoke delete on table "public"."profile" from "anon";

revoke insert on table "public"."profile" from "anon";

revoke references on table "public"."profile" from "anon";

revoke select on table "public"."profile" from "anon";

revoke trigger on table "public"."profile" from "anon";

revoke truncate on table "public"."profile" from "anon";

revoke update on table "public"."profile" from "anon";

revoke delete on table "public"."profile" from "authenticated";

revoke insert on table "public"."profile" from "authenticated";

revoke references on table "public"."profile" from "authenticated";

revoke select on table "public"."profile" from "authenticated";

revoke trigger on table "public"."profile" from "authenticated";

revoke truncate on table "public"."profile" from "authenticated";

revoke update on table "public"."profile" from "authenticated";

revoke delete on table "public"."profile" from "service_role";

revoke insert on table "public"."profile" from "service_role";

revoke references on table "public"."profile" from "service_role";

revoke select on table "public"."profile" from "service_role";

revoke trigger on table "public"."profile" from "service_role";

revoke truncate on table "public"."profile" from "service_role";

revoke update on table "public"."profile" from "service_role";

revoke delete on table "public"."room" from "anon";

revoke insert on table "public"."room" from "anon";

revoke references on table "public"."room" from "anon";

revoke select on table "public"."room" from "anon";

revoke trigger on table "public"."room" from "anon";

revoke truncate on table "public"."room" from "anon";

revoke update on table "public"."room" from "anon";

revoke delete on table "public"."room" from "authenticated";

revoke insert on table "public"."room" from "authenticated";

revoke references on table "public"."room" from "authenticated";

revoke select on table "public"."room" from "authenticated";

revoke trigger on table "public"."room" from "authenticated";

revoke truncate on table "public"."room" from "authenticated";

revoke update on table "public"."room" from "authenticated";

revoke delete on table "public"."room" from "service_role";

revoke insert on table "public"."room" from "service_role";

revoke references on table "public"."room" from "service_role";

revoke select on table "public"."room" from "service_role";

revoke trigger on table "public"."room" from "service_role";

revoke truncate on table "public"."room" from "service_role";

revoke update on table "public"."room" from "service_role";

revoke delete on table "public"."squad" from "anon";

revoke insert on table "public"."squad" from "anon";

revoke references on table "public"."squad" from "anon";

revoke select on table "public"."squad" from "anon";

revoke trigger on table "public"."squad" from "anon";

revoke truncate on table "public"."squad" from "anon";

revoke update on table "public"."squad" from "anon";

revoke delete on table "public"."squad" from "authenticated";

revoke insert on table "public"."squad" from "authenticated";

revoke references on table "public"."squad" from "authenticated";

revoke select on table "public"."squad" from "authenticated";

revoke trigger on table "public"."squad" from "authenticated";

revoke truncate on table "public"."squad" from "authenticated";

revoke update on table "public"."squad" from "authenticated";

revoke delete on table "public"."squad" from "service_role";

revoke insert on table "public"."squad" from "service_role";

revoke references on table "public"."squad" from "service_role";

revoke select on table "public"."squad" from "service_role";

revoke trigger on table "public"."squad" from "service_role";

revoke truncate on table "public"."squad" from "service_role";

revoke update on table "public"."squad" from "service_role";

create table "public"."squad_members" (
    "squad_id" bigint not null,
    "user_id" uuid not null
);


CREATE UNIQUE INDEX squad_members_pkey ON public.squad_members USING btree (squad_id, user_id);

alter table "public"."squad_members" add constraint "squad_members_pkey" PRIMARY KEY using index "squad_members_pkey";

alter table "public"."squad_members" add constraint "squad_members_squad_id_fkey" FOREIGN KEY (squad_id) REFERENCES squad(id) ON DELETE CASCADE not valid;

alter table "public"."squad_members" validate constraint "squad_members_squad_id_fkey";

alter table "public"."squad_members" add constraint "squad_members_user_id_fkey" FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE not valid;

alter table "public"."squad_members" validate constraint "squad_members_user_id_fkey";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.create_squad(p_name text, p_description text, p_course text, p_creator_id uuid, p_user_ids uuid[])
 RETURNS bigint
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_squad_id bigint;
BEGIN
    INSERT INTO public.squad(name, description, course, creator_id, visibility, is_deleted)
    VALUES (p_name, p_description, p_course, p_creator_id, 'open'::public.squad_visibility, FALSE)
    RETURNING id INTO v_squad_id;

    INSERT INTO public.squad_members(squad_id, user_id)
    SELECT v_squad_id, unnest(p_user_ids);

    RETURN v_squad_id;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_common_courses(user_ids uuid[])
 RETURNS TABLE(course text)
 LANGUAGE sql
AS $function$
  select course
  from public.enrolment
  where user_id = any(user_ids)
  group by course
  having count(distinct user_id) = array_length(user_ids, 1);
$function$
;



